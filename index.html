<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <title>PvZ Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            overflow: hidden;
            background: #1a1a2e;
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB 0%, #90EE90 100%);
        }
        
        .ui-layer {
            position: absolute;
            pointer-events: none;
        }
        
        #topPanel {
            top: 0;
            left: 0;
            right: 0;
            height: 10%;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            padding: 0 2%;
            pointer-events: auto;
        }
        
        .sun-counter {
            display: flex;
            align-items: center;
            background: rgba(255,200,0,0.9);
            padding: 8px 15px;
            border-radius: 25px;
            border: 3px solid #ff8c00;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-right: 15px;
        }
        
        .sun-icon {
            font-size: 28px;
            margin-right: 8px;
        }
        
        .selected-plant {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 20px;
            border: 3px solid #4CAF50;
            font-size: 16px;
            flex: 1;
        }
        
        .plant-preview {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        #pauseBtn, #settingsBtn {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border: 3px solid #666;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        #pauseBtn:active, #settingsBtn:active {
            transform: scale(0.95);
        }
        
        #plantPanel {
            position: absolute;
            left: 0;
            top: 10%;
            width: 15%;
            height: 90%;
            background: rgba(139,69,19,0.9);
            border-right: 4px solid #654321;
            overflow-y: auto;
            pointer-events: auto;
            padding: 10px 5px;
        }
        
        .plant-card {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(145deg, #8B4513, #A0522D);
            border: 3px solid #654321;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .plant-card:active {
            transform: scale(0.95);
        }
        
        .plant-card.selected {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.6);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .plant-card.disabled {
            opacity: 0.5;
            filter: grayscale(0.8);
        }
        
        .plant-card.cooldown::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .plant-emoji {
            font-size: 32px;
            margin-bottom: 2px;
        }
        
        .plant-cost {
            font-size: 14px;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        
        #gameArea {
            position: absolute;
            right: 0;
            top: 10%;
            width: 85%;
            height: 90%;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #4CAF50;
            text-align: center;
            max-width: 80%;
        }
        
        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .modal button {
            display: block;
            width: 200px;
            margin: 10px auto;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .btn-resume { background: #4CAF50; color: white; }
        .btn-restart { background: #ff9800; color: white; }
        .btn-menu { background: #f44336; color: white; }
        
        .modal button:active {
            transform: scale(0.95);
        }
        
        .wave-indicator {
            position: absolute;
            top: 12%;
            right: 5%;
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
        }
        
        .wave-indicator.active {
            display: block;
            animation: waveAlert 0.5s infinite alternate;
        }
        
        @keyframes waveAlert {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .toast {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 20px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 500;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #startScreen h1 {
            font-size: 48px;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }
        
        .start-btn {
            padding: 20px 60px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .start-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="startScreen">
        <h1>üåª Plants vs Zombies üßü</h1>
        <button class="start-btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
    </div>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div id="topPanel" style="display:none;">
        <div class="sun-counter">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span id="sunCount">150</span>
        </div>
        <div class="selected-plant" id="selectedPlantDisplay">
            <div class="plant-preview" style="background:#ddd;">‚ùì</div>
            <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</span>
        </div>
        <div id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è</div>
        <div id="settingsBtn" onclick="showSettings()">‚öôÔ∏è</div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–∞—Å—Ç–µ–Ω–∏–π -->
    <div id="plantPanel" style="display:none;">
        <div class="plant-card" data-type="sunflower" onclick="selectPlant('sunflower')">
            <div class="plant-emoji">üåª</div>
            <div class="plant-cost">50</div>
        </div>
        <div class="plant-card" data-type="peashooter" onclick="selectPlant('peashooter')">
            <div class="plant-emoji">üå±</div>
            <div class="plant-cost">100</div>
        </div>
        <div class="plant-card" data-type="repeater" onclick="selectPlant('repeater')">
            <div class="plant-emoji">üåøüåø</div>
            <div class="plant-cost">175</div>
        </div>
        <div class="plant-card" data-type="wallnut" onclick="selectPlant('wallnut')">
            <div class="plant-emoji">ü•ú</div>
            <div class="plant-cost">50</div>
        </div>
        <div class="plant-card" data-type="cherrybomb" onclick="selectPlant('cherrybomb')">
            <div class="plant-emoji">üçíüí£</div>
            <div class="plant-cost">125</div>
        </div>
        <div class="plant-card" data-type="snowpea" onclick="selectPlant('snowpea')">
            <div class="plant-emoji">‚ùÑÔ∏è</div>
            <div class="plant-cost">150</div>
        </div>
        <div class="plant-card" data-type="cabbage" onclick="selectPlant('cabbage')">
            <div class="plant-emoji">ü•¨</div>
            <div class="plant-cost">100</div>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
    <div id="gameArea" style="display:none;">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–æ–ª–Ω—ã -->
    <div class="wave-indicator" id="waveIndicator">–í–û–õ–ù–ê!</div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="toast" id="toast"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—É–∑—ã -->
    <div class="modal" id="pauseModal">
        <div class="modal-content">
            <h2>‚è∏Ô∏è –ü–ê–£–ó–ê</h2>
            <button class="btn-resume" onclick="togglePause()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="btn-restart" onclick="restartGame()">–ó–∞–Ω–æ–≤–æ</button>
            <button class="btn-menu" onclick="location.reload()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ Game Over -->
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 id="gameOverTitle">üß† –ó–û–ú–ë–ò –°–™–ï–õ–ò –í–ê–® –ú–û–ó–ì!</h2>
            <p id="finalScore" style="font-size:20px;margin-bottom:20px;"></p>
            <button class="btn-restart" onclick="restartGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            <button class="btn-menu" onclick="location.reload()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        // –ò–≥—Ä–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const ROWS = 5;
        const COLS = 9;
        const CELL_WIDTH_PERCENT = 70 / COLS; // 70% —à–∏—Ä–∏–Ω—ã –Ω–∞ –ø–æ–ª–µ
        const CELL_HEIGHT_PERCENT = 80 / ROWS; // 80% –≤—ã—Å–æ—Ç—ã –Ω–∞ –ø–æ–ª–µ
        
        // –¢–∏–ø—ã —Ä–∞—Å—Ç–µ–Ω–∏–π
        const PLANTS = {
            sunflower: { 
                cost: 50, 
                cooldown: 4000, 
                hp: 300, 
                emoji: 'üåª',
                color: '#FFD700',
                autoCollect: true,
                sunProduction: 25,
                sunInterval: 8000
            },
            peashooter: { 
                cost: 100, 
                cooldown: 4000, 
                hp: 300, 
                damage: 25, 
                fireRate: 1500, 
                emoji: 'üå±',
                color: '#32CD32',
                projectile: 'pea'
            },
            repeater: { 
                cost: 175, 
                cooldown: 8000, 
                hp: 300, 
                damage: 25, 
                fireRate: 1500, 
                double: true,
                emoji: 'üåø',
                color: '#228B22',
                projectile: 'pea'
            },
            wallnut: { 
                cost: 50, 
                cooldown: 12000, 
                hp: 5000, 
                emoji: 'ü•ú',
                color: '#8B4513',
                defensive: true
            },
            cherrybomb: { 
                cost: 125, 
                cooldown: 25000, 
                hp: 100, 
                damage: 1800, 
                radius: 3.5,
                instant: true,
                emoji: 'üçí',
                color: '#DC143C'
            },
            snowpea: { 
                cost: 150, 
                cooldown: 6000, 
                hp: 300, 
                damage: 20, 
                fireRate: 1500, 
                slow: 4000,
                emoji: '‚ùÑÔ∏è',
                color: '#87CEEB',
                projectile: 'snow'
            },
            cabbage: { 
                cost: 100, 
                cooldown: 4000, 
                hp: 300, 
                damage: 50, 
                fireRate: 3000, 
                emoji: 'ü•¨',
                color: '#90EE90',
                projectile: 'cabbage',
                lobbed: true
            }
        };

        // –¢–∏–ø—ã –∑–æ–º–±–∏
        const ZOMBIES = {
            normal: { hp: 180, speed: 0.4, damage: 10, emoji: 'üßü', color: '#8B4513' },
            cone: { hp: 500, speed: 0.4, damage: 10, emoji: 'üßü', color: '#FF8C00', armor: 320 },
            bucket: { hp: 1100, speed: 0.4, damage: 10, emoji: 'üßü', color: '#C0C0C0', armor: 920 },
            runner: { hp: 280, speed: 0.8, damage: 10, emoji: 'üèÉ', color: '#FF6347', slowFactor: 0.5 }
        };

        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let canvas, ctx;
        let cellWidth, cellHeight;
        let offsetX, offsetY;
        let sun = 150;
        let selectedPlant = null;
        let plants = [];
        let zombies = [];
        let projectiles = [];
        let suns = [];
        let particles = [];
        let lastTime = 0;
        let gameRunning = false;
        let paused = false;
        let wave = 1;
        let waveTimer = 0;
        let nextWaveTime = 30000;
        let cooldowns = {};
        let lastDoubleTap = 0;
        let lastUsedPlant = null;
        let touchStartY = 0;
        let longPressTimer = null;
        let selectedCell = null;
        let autoCollect = false;
        let frameCount = 0;
        let fps = 60;
        let lowQuality = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const cores = navigator.hardwareConcurrency || 4;
            lowQuality = cores < 4;
            
            resize();
            window.addEventListener('resize', resize);
            
            // Touch —Å–æ–±—ã—Ç–∏—è
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            
            // –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            document.addEventListener('gesturestart', e => e.preventDefault());
            document.addEventListener('gesturechange', e => e.preventDefault());
            document.addEventListener('gestureend', e => e.preventDefault());
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É–ª–¥–∞—É–Ω–æ–≤
            Object.keys(PLANTS).forEach(type => cooldowns[type] = 0);
            
            requestAnimationFrame(gameLoop);
        }

        function resize() {
            const gameArea = document.getElementById('gameArea');
            canvas.width = gameArea.clientWidth;
            canvas.height = gameArea.clientHeight;
            
            // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —è—á–µ–µ–∫
            const availableWidth = canvas.width * 0.95;
            const availableHeight = canvas.height * 0.95;
            
            cellWidth = Math.min(availableWidth / COLS, availableHeight / ROWS);
            cellHeight = cellWidth;
            
            offsetX = (canvas.width - cellWidth * COLS) / 2;
            offsetY = (canvas.height - cellHeight * ROWS) / 2;
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('topPanel').style.display = 'flex';
            document.getElementById('plantPanel').style.display = 'block';
            document.getElementById('gameArea').style.display = 'block';
            
            init();
            gameRunning = true;
            showToast('–ì–æ—Ç–æ–≤—å—Å—è! –ü–µ—Ä–≤–∞—è –≤–æ–ª–Ω–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫');
        }

        function selectPlant(type) {
            if (cooldowns[type] > 0) return;
            if (sun < PLANTS[type].cost) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–ª–Ω—ã—à–µ–∫!');
                return;
            }
            
            selectedPlant = type;
            lastUsedPlant = type;
            updatePlantPanel();
            updateSelectedDisplay();
        }

        function updatePlantPanel() {
            document.querySelectorAll('.plant-card').forEach(card => {
                const type = card.dataset.type;
                const plant = PLANTS[type];
                
                card.classList.remove('selected', 'disabled', 'cooldown');
                
                if (type === selectedPlant) {
                    card.classList.add('selected');
                }
                
                if (sun < plant.cost) {
                    card.classList.add('disabled');
                }
                
                if (cooldowns[type] > 0) {
                    card.classList.add('cooldown');
                    const remaining = Math.ceil(cooldowns[type] / 1000);
                    card.style.setProperty('--cooldown-text', `"${remaining}"`);
                }
            });
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selectedPlantDisplay');
            if (selectedPlant) {
                const plant = PLANTS[selectedPlant];
                display.innerHTML = `
                    <div class="plant-preview" style="background:${plant.color};">${plant.emoji}</div>
                    <span>${getPlantName(selectedPlant)}</span>
                `;
            } else {
                display.innerHTML = `
                    <div class="plant-preview" style="background:#ddd;">‚ùì</div>
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</span>
                `;
            }
        }

        function getPlantName(type) {
            const names = {
                sunflower: '–ü–æ–¥—Å–æ–ª–Ω—É—Ö',
                peashooter: '–ì–æ—Ä–æ—Ö–æ—Å—Ç—Ä–µ–ª',
                repeater: '–î–≤–æ–π–Ω–æ–π –≥–æ—Ä–æ—Ö',
                wallnut: '–û—Ä–µ—Ö',
                cherrybomb: '–í–∏—à–Ω–µ–≤–∞—è –±–æ–º–±–∞',
                snowpea: '–°–Ω–µ–∂–Ω—ã–π –≥–æ—Ä–æ—Ö',
                cabbage: '–ö–∞–ø—É—Å—Ç–∞'
            };
            return names[type] || type;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            touchStartY = touch.clientY;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞
            const now = Date.now();
            if (now - lastDoubleTap < 300 && lastUsedPlant) {
                selectedPlant = lastUsedPlant;
                tryPlant(x, y);
                return;
            }
            lastDoubleTap = now;
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–µ—Ç–∫–∏
            const col = Math.floor((x - offsetX) / cellWidth);
            const row = Math.floor((y - offsetY) / cellHeight);
            
            if (col >= 0 && col < COLS && row >= 0 && row < ROWS) {
                selectedCell = {row, col};
                
                // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏/—É–¥–∞–ª–µ–Ω–∏—è
                longPressTimer = setTimeout(() => {
                    showCellInfo(row, col);
                }, 500);
            }
            
            // –°–±–æ—Ä —Å–æ–ª–Ω—ã—à–∫–∞
            collectSun(x, y);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (Math.abs(e.touches[0].clientY - touchStartY) > 50) {
                // –°–≤–∞–π–ø –≤–Ω–∏–∑ - –æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞
                clearTimeout(longPressTimer);
                selectedPlant = null;
                updatePlantPanel();
                updateSelectedDisplay();
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            clearTimeout(longPressTimer);
            
            const touch = e.changedTouches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const col = Math.floor((x - offsetX) / cellWidth);
            const row = Math.floor((y - offsetY) / cellHeight);
            
            if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
                if (selectedPlant) {
                    tryPlant(x, y);
                }
            }
            
            selectedCell = null;
        }

        function tryPlant(x, y) {
            const col = Math.floor((x - offsetX) / cellWidth);
            const row = Math.floor((y - offsetY) / cellHeight);
            
            if (col < 0 || col >= COLS || row < 0 || row >= ROWS) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
            const existing = plants.find(p => p.row === row && p.col === col);
            if (existing) {
                showToast('–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞!');
                return;
            }
            
            const plantType = PLANTS[selectedPlant];
            if (sun < plantType.cost) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–ª–Ω—ã—à–µ–∫!');
                return;
            }
            
            // –ü–æ—Å–∞–¥–∫–∞
            sun -= plantType.cost;
            cooldowns[selectedPlant] = plantType.cooldown;
            
            const plant = {
                type: selectedPlant,
                row: row,
                col: col,
                x: offsetX + col * cellWidth + cellWidth/2,
                y: offsetY + row * cellHeight + cellHeight/2,
                hp: plantType.hp,
                maxHp: plantType.hp,
                lastShot: 0,
                lastSun: Date.now(),
                slow: 0
            };
            
            plants.push(plant);
            
            // –í–∏—à–Ω–µ–≤–∞—è –±–æ–º–±–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è
            if (selectedPlant === 'cherrybomb') {
                explodeCherry(plant);
            }
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ—Å–∞–¥–∫–∏
            createParticles(plant.x, plant.y, plantType.color, 10);
            
            updatePlantPanel();
            updateSunDisplay();
            
            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –ø–æ—Å–ª–µ –ø–æ—Å–∞–¥–∫–∏ (–∫—Ä–æ–º–µ –±—ã—Å—Ç—Ä–æ–π –ø–æ—Å–∞–¥–∫–∏)
            // selectedPlant = null;
            // updateSelectedDisplay();
        }

        function explodeCherry(plant) {
            const radius = PLANTS.cherrybomb.radius * cellWidth;
            
            // –£—Ä–æ–Ω –∑–æ–º–±–∏
            zombies.forEach(zombie => {
                const dx = zombie.x - plant.x;
                const dy = zombie.y - plant.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < radius) {
                    zombie.hp -= PLANTS.cherrybomb.damage;
                    createParticles(zombie.x, zombie.y, '#FF0000', 5);
                }
            });
            
            // –£—Ä–æ–Ω —Ä–∞—Å—Ç–µ–Ω–∏—è–º (–Ω–µ–±–æ–ª—å—à–æ–π)
            plants.forEach(p => {
                if (p !== plant) {
                    const dx = p.x - plant.x;
                    const dy = p.y - plant.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < radius * 0.5) {
                        p.hp -= 50;
                    }
                }
            });
            
            createParticles(plant.x, plant.y, '#FF4500', 30);
            if (navigator.vibrate) navigator.vibrate(200);
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –±–æ–º–±—ã
            const idx = plants.indexOf(plant);
            if (idx > -1) plants.splice(idx, 1);
        }

        function showCellInfo(row, col) {
            const plant = plants.find(p => p.row === row && p.col === col);
            if (plant) {
                const percent = Math.round((plant.hp / PLANTS[plant.type].hp) * 100);
                showToast(`${getPlantName(plant.type)}: ${percent}% HP`);
                
                // –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–∫–æ–ø–∞—Ç—å (—É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–æ–ª—å—à–µ)
                setTimeout(() => {
                    if (confirm(`–í—ã–∫–æ–ø–∞—Ç—å ${getPlantName(plant.type)}? –í–µ—Ä–Ω–µ—Ç—Å—è ${Math.floor(PLANTS[plant.type].cost * 0.5)} —Å–æ–ª–Ω—ã—à–µ–∫`)) {
                        sun += Math.floor(PLANTS[plant.type].cost * 0.5);
                        const idx = plants.indexOf(plant);
                        if (idx > -1) plants.splice(idx, 1);
                        updateSunDisplay();
                    }
                }, 1000);
            }
        }

        function collectSun(x, y) {
            for (let i = suns.length - 1; i >= 0; i--) {
                const sun = suns[i];
                const dx = x - sun.x;
                const dy = y - sun.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                // –ú–∞–≥–Ω–∏—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç - –µ—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –±–ª–∏–∑–∫–æ, –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º
                if (dist < cellWidth * 1.5 || dist < 50) {
                    suns.splice(i, 1);
                    addSun(sun.amount);
                    createParticles(sun.x, sun.y, '#FFD700', 5);
                    return true;
                }
            }
            return false;
        }

        function addSun(amount) {
            sun += amount;
            updateSunDisplay();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–ª–∞
            const toast = document.getElementById('toast');
            toast.textContent = `+${amount} ‚òÄÔ∏è`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1000);
        }

        function updateSunDisplay() {
            document.getElementById('sunCount').textContent = sun;
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.textContent = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function spawnZombie() {
            const types = ['normal', 'normal', 'cone', 'bucket', 'runner'];
            const type = types[Math.floor(Math.random() * Math.min(types.length, wave / 2 + 2))] || 'normal';
            const zombieType = ZOMBIES[type];
            
            const row = Math.floor(Math.random() * ROWS);
            
            const zombie = {
                type: type,
                row: row,
                x: canvas.width,
                y: offsetY + row * cellHeight + cellHeight/2,
                hp: zombieType.hp,
                maxHp: zombieType.hp,
                speed: zombieType.speed * cellWidth,
                damage: zombieType.damage,
                eating: false,
                slow: 0,
                armor: zombieType.armor || 0
            };
            
            zombies.push(zombie);
        }

        function gameLoop(timestamp) {
            if (!gameRunning || paused) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ FPS –Ω–∞ —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            if (lowQuality && dt < 33) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            update(dt);
            render();
            
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–≤
            Object.keys(cooldowns).forEach(type => {
                if (cooldowns[type] > 0) {
                    cooldowns[type] -= dt;
                    if (cooldowns[type] < 0) cooldowns[type] = 0;
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–∞–∂–¥—ã–µ 500–º—Å
            frameCount++;
            if (frameCount % 30 === 0) {
                updatePlantPanel();
            }
            
            // –í–æ–ª–Ω—ã –∑–æ–º–±–∏
            waveTimer += dt;
            if (waveTimer > nextWaveTime) {
                waveTimer = 0;
                startWave();
            }
            
            // –°–ø–∞–≤–Ω –∑–æ–º–±–∏
            if (zombies.length < 8 && Math.random() < 0.02 + wave * 0.005) {
                spawnZombie();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏–π
            plants.forEach(plant => {
                const type = PLANTS[plant.type];
                
                // –ü–æ–¥—Å–æ–ª–Ω—É—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–æ–ª–Ω—Ü–µ
                if (plant.type === 'sunflower' && Date.now() - plant.lastSun > type.sunInterval) {
                    plant.lastSun = Date.now();
                    if (type.autoCollect) {
                        addSun(type.sunProduction);
                        createParticles(plant.x, plant.y, '#FFD700', 3);
                    } else {
                        suns.push({
                            x: plant.x + (Math.random() - 0.5) * 50,
                            y: plant.y - 30,
                            amount: type.sunProduction,
                            vx: (Math.random() - 0.5) * 2,
                            vy: -2
                        });
                    }
                }
                
                // –°—Ç—Ä–µ–ª—è—é—â–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                if (type.projectile && Date.now() - plant.lastShot > type.fireRate) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–º–±–∏ –≤ —Ä—è–¥—É
                    const hasZombie = zombies.some(z => z.row === plant.row && z.x > plant.x);
                    if (hasZombie) {
                        plant.lastShot = Date.now();
                        shoot(plant, type);
                        
                        if (type.double) {
                            setTimeout(() => shoot(plant, type), 200);
                        }
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–¥–æ–≤
            projectiles.forEach((proj, i) => {
                proj.x += proj.vx;
                proj.y += proj.vy || 0;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –∑–æ–º–±–∏
                for (let j = zombies.length - 1; j >= 0; j--) {
                    const zombie = zombies[j];
                    if (zombie.row === proj.row && 
                        Math.abs(zombie.x - proj.x) < cellWidth/2 &&
                        Math.abs(zombie.y - proj.y) < cellHeight/2) {
                        
                        zombie.hp -= proj.damage;
                        if (proj.slow) {
                            zombie.slow = proj.slow;
                        }
                        
                        projectiles.splice(i, 1);
                        createParticles(proj.x, proj.y, proj.color, 3);
                        break;
                    }
                }
                
                // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
                if (proj.x > canvas.width) {
                    projectiles.splice(i, 1);
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–æ–º–±–∏
            for (let i = zombies.length - 1; i >= 0; i--) {
                const zombie = zombies[i];
                const type = ZOMBIES[zombie.type];
                
                // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
                let speed = zombie.speed;
                if (zombie.slow > 0) {
                    speed *= 0.5;
                    zombie.slow -= dt;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏
                let blocked = false;
                for (const plant of plants) {
                    if (plant.row === zombie.row && 
                        Math.abs(plant.x - zombie.x) < cellWidth/2) {
                        
                        blocked = true;
                        zombie.eating = true;
                        plant.hp -= zombie.damage * (dt / 1000);
                        
                        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∞—Ç–∞–∫–∏
                        if (frameCount % 10 === 0) {
                            createParticles(plant.x, plant.y, '#FF0000', 2);
                        }
                        
                        if (plant.hp <= 0) {
                            createParticles(plant.x, plant.y, PLANTS[plant.type].color, 15);
                        }
                        break;
                    }
                }
                
                if (!blocked) {
                    zombie.eating = false;
                    zombie.x -= speed * (dt / 1000);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–æ–º–∞
                if (zombie.x < offsetX) {
                    gameOver();
                    return;
                }
                
                // –°–º–µ—Ä—Ç—å –∑–æ–º–±–∏
                if (zombie.hp <= 0) {
                    createParticles(zombie.x, zombie.y, '#8B4513', 10);
                    zombies.splice(i, 1);
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–ª–Ω—ã—à–µ–∫
            suns.forEach((sun, i) => {
                sun.vy += 0.1; // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                sun.x += sun.vx;
                sun.y += sun.vy;
                
                // –ú–∞–≥–Ω–∏—Ç –∫ –∫–∞—Å–∞–Ω–∏—é (—Å–∏–º—É–ª—è—Ü–∏—è)
                // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ handleTouchStart
                
                if (sun.y > canvas.height) {
                    suns.splice(i, 1);
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= dt;
                p.vy += 0.2;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            // –û—á–∏—Å—Ç–∫–∞ –º–µ—Ä—Ç–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π
            plants = plants.filter(p => p.hp > 0);
        }

        function shoot(plant, type) {
            const projectile = {
                x: plant.x + 20,
                y: plant.y,
                row: plant.row,
                vx: 8,
                damage: type.damage,
                color: type.projectile === 'snow' ? '#87CEEB' : '#32CD32',
                slow: type.slow || 0
            };
            
            if (type.lobbed) {
                projectile.vx = 6;
                projectile.vy = -8;
            }
            
            projectiles.push(projectile);
        }

        function createParticles(x, y, color, count) {
            if (lowQuality && particles.length > 50) return;
            
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 5,
                    life: 1000,
                    color: color,
                    size: Math.random() * 5 + 3
                });
            }
        }

        function startWave() {
            wave++;
            document.getElementById('waveIndicator').classList.add('active');
            showToast(`–í–û–õ–ù–ê ${wave}!`);
            
            // –°–ø–∞–≤–Ω –≥—Ä—É–ø–ø—ã –∑–æ–º–±–∏
            const count = Math.min(3 + Math.floor(wave / 2), 8);
            for (let i = 0; i < count; i++) {
                setTimeout(() => spawnZombie(), i * 1000);
            }
            
            setTimeout(() => {
                document.getElementById('waveIndicator').classList.remove('active');
            }, 3000);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            saveGame();
        }

        function render() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 2;
            
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    const x = offsetX + col * cellWidth;
                    const y = offsetY + row * cellHeight;
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫
                    if (selectedPlant) {
                        const occupied = plants.some(p => p.row === row && p.col === col);
                        ctx.fillStyle = occupied ? 'rgba(255,0,0,0.2)' : 'rgba(0,255,0,0.2)';
                        ctx.fillRect(x, y, cellWidth, cellHeight);
                    }
                    
                    ctx.strokeRect(x, y, cellWidth, cellHeight);
                }
            }
            
            // –†–∏—Å—É–µ–º –≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∏
            for (let row = 0; row < ROWS; row++) {
                const y = offsetY + row * cellHeight + cellHeight/2;
                ctx.font = `${cellHeight * 0.6}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üöú', offsetX - cellWidth/2, y);
            }
            
            // –†–∏—Å—É–µ–º —Ä–∞—Å—Ç–µ–Ω–∏—è
            plants.forEach(plant => {
                const type = PLANTS[plant.type];
                
                // –¢–µ–Ω—å
                if (!lowQuality) {
                    ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    ctx.beginPath();
                    ctx.ellipse(plant.x, plant.y + 10, cellWidth/3, cellHeight/6, 0, 0, Math.PI*2);
                    ctx.fill();
                }
                
                // –†–∞—Å—Ç–µ–Ω–∏–µ
                ctx.font = `${cellHeight * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(type.emoji, plant.x, plant.y);
                
                // –ü–æ–ª–æ—Å–∫–∞ HP –¥–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π
                if (type.defensive || plant.hp < type.hp) {
                    const hpPercent = plant.hp / type.hp;
                    ctx.fillStyle = 'red';
                    ctx.fillRect(plant.x - 20, plant.y - 30, 40, 5);
                    ctx.fillStyle = 'green';
                    ctx.fillRect(plant.x - 20, plant.y - 30, 40 * hpPercent, 5);
                }
            });
            
            // –†–∏—Å—É–µ–º –∑–æ–º–±–∏
            zombies.forEach(zombie => {
                const type = ZOMBIES[zombie.type];
                
                // –¢–µ–Ω—å
                if (!lowQuality) {
                    ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    ctx.beginPath();
                    ctx.ellipse(zombie.x, zombie.y + 10, cellWidth/3, cellHeight/6, 0, 0, Math.PI*2);
                    ctx.fill();
                }
                
                // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
                if (zombie.slow > 0) {
                    ctx.fillStyle = 'rgba(135,206,235,0.5)';
                    ctx.beginPath();
                    ctx.arc(zombie.x, zombie.y, cellWidth/2.5, 0, Math.PI*2);
                    ctx.fill();
                }
                
                // –ó–æ–º–±–∏
                ctx.font = `${cellHeight * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–µ–¥–∞–Ω–∏—è
                if (zombie.eating && frameCount % 20 < 10) {
                    ctx.translate(zombie.x, zombie.y);
                    ctx.rotate(0.1);
                    ctx.fillText(type.emoji, 0, 0);
                    ctx.rotate(-0.1);
                    ctx.translate(-zombie.x, -zombie.y);
                } else {
                    ctx.fillText(type.emoji, zombie.x, zombie.y);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ HP
                if (zombie.hp < type.hp) {
                    const hpPercent = zombie.hp / type.hp;
                    ctx.fillStyle = 'red';
                    ctx.fillRect(zombie.x - 20, zombie.y - 35, 40, 4);
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(zombie.x - 20, zombie.y - 35, 40 * hpPercent, 4);
                }
            });
            
            // –†–∏—Å—É–µ–º —Å–Ω–∞—Ä—è–¥—ã
            ctx.font = `${cellHeight * 0.25}px Arial`;
            projectiles.forEach(proj => {
                ctx.fillText(proj.color === '#87CEEB' ? '‚ùÑÔ∏è' : 'üü¢', proj.x, proj.y);
            });
            
            // –†–∏—Å—É–µ–º —Å–æ–ª–Ω—ã—à–∫–∏
            suns.forEach(sun => {
                ctx.font = `${cellHeight * 0.4}px Arial`;
                ctx.fillText('‚òÄÔ∏è', sun.x, sun.y);
            });
            
            // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã
            if (!lowQuality || particles.length < 100) {
                particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 1000;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                });
            }
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('pauseModal').classList.toggle('active', paused);
            if (!paused) {
                lastTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        }

        function restartGame() {
            plants = [];
            zombies = [];
            projectiles = [];
            suns = [];
            particles = [];
            sun = 150;
            wave = 1;
            waveTimer = 0;
            selectedPlant = null;
            gameRunning = true;
            paused = false;
            
            Object.keys(cooldowns).forEach(k => cooldowns[k] = 0);
            
            document.getElementById('pauseModal').classList.remove('active');
            document.getElementById('gameOverModal').classList.remove('active');
            
            updatePlantPanel();
            updateSelectedDisplay();
            updateSunDisplay();
            
            lastTime = performance.now();
        }

        function gameOver() {
            gameRunning = false;
            document.getElementById('gameOverTitle').textContent = wave > 5 ? 'üéâ –ü–û–ë–ï–î–ê!' : 'üß† –ó–û–ú–ë–ò –°–™–ï–õ–ò –í–ê–® –ú–û–ó–ì!';
            document.getElementById('finalScore').textContent = `–ü—Ä–æ–π–¥–µ–Ω–æ –≤–æ–ª–Ω: ${wave}`;
            document.getElementById('gameOverModal').classList.add('active');
            
            // –í–∏–±—Ä–∞—Ü–∏—è
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }

        function saveGame() {
            const saveData = {
                wave: wave,
                sun: sun,
                record: Math.max(wave, localStorage.getItem('pvz_record') || 0)
            };
            localStorage.setItem('pvz_save', JSON.stringify(saveData));
            localStorage.setItem('pvz_record', saveData.record);
        }

        function loadGame() {
            const save = localStorage.getItem('pvz_save');
            if (save) {
                const data = JSON.parse(save);
                // –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            }
        }

        function showSettings() {
            autoCollect = confirm('–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Å–±–æ—Ä —Å–æ–ª–Ω—ã—à–µ–∫?');
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => new Response('Offline'))));
            `)).catch(() => {});
        }
    </script>
</body>
</html>
